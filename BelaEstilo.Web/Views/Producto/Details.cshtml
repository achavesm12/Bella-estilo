@model BelaEstilo.Application.DTOs.ProductoDTO

@{
    ViewData["Title"] = "Detalle del Producto";
}


<h1 class="text-center py-3" style="background-color: #f8d7da; color: #721c24;">Detalle del Producto</h1>

<div class="container border p-4 shadow-lg">
    <div class="row">
        <div class="col-md-5 text-center">
            @if (Model.ImagenProducto != null && Model.ImagenProducto.Any())
{
    <div id="carouselProducto" class="carousel slide mb-3" data-bs-ride="carousel">
        <div class="carousel-inner">
            @for (int i = 0; i < Model.ImagenProducto.Count(); i++)
            {
                var img = Model.ImagenProducto.ElementAt(i);
                if (img.Imagen != null && img.Imagen.Length > 0)
                {
                    <div class="carousel-item @(i == 0 ? "active" : "")">
                        <img src="data:image/jpeg;charset=utf-8;base64,@Convert.ToBase64String(img.Imagen)"
                             class="d-block w-100 rounded"
                             style="max-height: 350px; object-fit: contain;" 
                             alt="Imagen de @Model.Nombre">
                    </div>
                }
            }
        </div>

        @if (Model.ImagenProducto.Count() > 1)
        {
            <button class="carousel-control-prev" type="button" data-bs-target="#carouselProducto" data-bs-slide="prev">
                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                <span class="visually-hidden">Anterior</span>
            </button>
            <button class="carousel-control-next" type="button" data-bs-target="#carouselProducto" data-bs-slide="next">
                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                <span class="visually-hidden">Siguiente</span>
            </button>
        }
    </div>
        }
        else
        {
        <p>No hay imágenes disponibles.</p>
        }
        </div>
        <div class="col-md-7">
            <h3>@Model.Nombre</h3>
            <p><strong>Descripción:</strong> @Model.Descripcion</p>
            <p><strong>Precio:</strong> ¢@Model.Precio</p>
            <p><strong>Stock disponible:</strong> @Model.Stock</p>
            <p><strong>Tipo de tela:</strong> @Model.TipoTela</p>
            <p><strong>Tallas disponibles:</strong> @Model.TallaDisponible</p>
            <p><strong>Categoría:</strong> @Model.IdCategoriaNavigation.Nombre</p>

            <p>
                <strong>Etiquetas:</strong>
                @if (Model.IdEtiqueta != null && Model.IdEtiqueta.Any())
                {
                    foreach (var etiqueta in Model.IdEtiqueta)
                    {
                        <span class="badge bg-primary me-1">@etiqueta.Nombre</span>
                    }
                }
                else
                {
                    <span>No tiene etiquetas.</span>
                }
            </p>

            <p>
                <strong>Valoración promedio:</strong>
                @{
                    decimal promedioValoracion = 0;
                    if (Model.Resena != null && Model.Resena.Any())
                    {
                        double? avgNullable = Model.Resena.Average(r => (double?)r.Valoracion);
                        double avg = avgNullable ?? 0; // Si es null, toma 0
                        promedioValoracion = Math.Round(Convert.ToDecimal(avg), 1);
                    }

                    int estrellasCompletas = (int)Math.Floor(promedioValoracion);
                }

                @for (int i = 1; i <= 5; i++)
                {
                    if (i <= estrellasCompletas)
                    {
                        <span class="text-warning">&#9733;</span> <!-- estrella llena -->
                    }
                    else
                    {
                        <span class="text-secondary">&#9734;</span> <!-- estrella vacía -->
                    }
                }
                (@promedioValoracion.ToString("0.0"))
            </p>

            <!-- Producto personalizado -->
            <div class="mt-3 d-flex flex-wrap gap-2">
                <a class="btn"
                   style="background-color: #646096; color: white; font-weight: 600; border: none;"
                   asp-controller="PedidoPersonalizado"
                   asp-action="Create"
                   asp-route-idProducto="@Model.IdProducto">
                    Personalizar este producto
                </a>

            </div>
            <!--  -->
            <!-- Producto normal -->
            <form asp-action="AgregarProducto" asp-controller="Producto" method="post" class="mt-2">
                <input type="hidden" name="idProducto" value="@Model.IdProducto" />
                <input type="hidden" name="cantidad" value="1" />
                @if (Model.Stock > 0)
                {
                    <button type="submit" class="btn" style="background-color: #353257; color: white;">
                        <i class="bi bi-cart-plus"></i> Agregar sin personalizar
                    </button>

                }
                else
                {
                    <button type="button" class="btn btn-secondary" disabled>
                        Sin stock disponible
                    </button>
                }
            </form>


        </div>
    </div>

    <hr />

    <hr />
    <h4 class="mt-4 text-center">Reseñas de clientes</h4>

    @if (Model.Resena != null && Model.Resena.Any())
    {
        foreach (var resena in Model.Resena.OrderByDescending(r => r.Fecha))
        {
            <div class="border rounded p-3 mb-3 shadow-sm">
                <p><strong>@resena.IdUsuarioNavigation.Nombre</strong> - @resena.Fecha?.ToString("dd/MM/yyyy")</p>

                <p>
                    @for (int i = 1; i <= 5; i++)
                    {
                        if (i <= resena.Valoracion)
                        {
                            <span class="text-warning">&#9733;</span>
                        }
                        else
                        {
                            <span class="text-secondary">&#9734;</span>
                        }
                    }
                </p>

                <p>@resena.Comentario</p>
            </div>
        }
    }
    else
    {
        <p class="text-muted">Este producto aún no tiene reseñas.</p>
    }
    @if (User.Identity.IsAuthenticated && User.IsInRole("Cliente"))
    {
        <a asp-controller="Resena" asp-action="Create" asp-route-idProducto="@Model.IdProducto"
           class="btn btn-secondary mt-3">
            Crear Reseña
        </a>
    }


    <div class="text-center mt-4">
        <a class="btn btn-info" style="background-color: #c2185b; color: white;" asp-action="Index">Regresar al listado</a>
    </div>
</div>

@await Html.PartialAsync("_Notificaciones")
